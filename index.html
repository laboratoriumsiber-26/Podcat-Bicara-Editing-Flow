<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Bicara - Realtime Workflow</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --ios-blue: #007AFF; --ios-red: #FF3B30; --ios-green: #34C759;
            --ios-yellow: #FFCC00; --ios-bg: #F2F2F7;
        }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--ios-bg); color: #000; }
        
        /* Loading Overlay */
        #loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--ios-blue); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #login-page { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1590602847861-f357a9332bbc?q=80&w=1920') center/cover; }
        .login-card { background: white; padding: 30px; border-radius: 25px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #dashboard-page { display: none; padding: 20px; max-width: 1550px; margin: auto; }
        
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .analytics-section { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-box { background: white; padding: 15px; border-radius: 20px; width: 180px; height: 180px; display: flex; justify-content: center; align-items: center; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; flex-grow: 1; }
        .stat-card { background: white; padding: 15px; border-radius: 18px; border-left: 4px solid var(--ios-blue); }
        .stat-card b { font-size: 24px; display: block; }
        
        .table-container { background: white; border-radius: 20px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; }
        th { background: #f9f9f9; padding: 15px; text-align: left; font-size: 11px; color: #888; border-bottom: 1px solid #eee; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f2f2f7; font-size: 13px; }
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 5vh auto; padding: 25px; width: 90%; max-width: 450px; border-radius: 25px; max-height: 85vh; overflow-y: auto; position: relative; }
        
        .input-group { margin-bottom: 12px; }
        label { font-size: 11px; font-weight: bold; color: #888; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; font-family: inherit; }
        
        .btn-main { background: var(--ios-blue); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-danger { background: var(--ios-red); color: white; border: none; padding: 12px; border-radius: 12px; margin-top: 15px; cursor: pointer; width: 100%; }
        .pill { padding: 4px 10px; border-radius: 8px; font-size: 10px; font-weight: bold; display: inline-block; color: white; }
        
        .blink-red { animation: blinker 1s linear infinite; background-color: var(--ios-red) !important; }
        @keyframes blinker { 50% { opacity: 0.3; } }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="loading-screen" style="display: none;">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#666; font-size:14px;">Menghubungkan ke Spreadsheet...</p>
    </div>

    <div id="login-page">
        <div class="login-card">
            <h2 style="margin-top:0">Podcast Bicara</h2>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password" style="margin-top:10px">
            <button class="btn-main" style="width:100%; margin-top:20px" onclick="handleLogin()">Sign In</button>
        </div>
    </div>

    <div id="dashboard-page">
        <div class="header-bar">
            <div>
                <h2 style="margin:0">Production Workflow</h2>
                <small id="user-info" style="color:#666"></small>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-main" style="background:#8e8e93" onclick="refreshData()"><i class="fa-solid fa-sync"></i></button>
                <button class="btn-main" style="background:#333" onclick="handleLogout()">Logout</button>
            </div>
        </div>

        <div class="analytics-section">
            <div class="chart-box"><canvas id="statusChart"></canvas></div>
            <div class="stats-grid">
                <div class="stat-card"><span>Total Project</span><b id="stat-total">0</b></div>
                <div class="stat-card"><span>To do</span><b id="stat-todo">0</b></div>
                <div class="stat-card" style="border-left-color: var(--ios-yellow);"><span>In Progress</span><b id="stat-progress">0</b></div>
                <div class="stat-card" style="border-left-color: var(--ios-green);"><span>Finalized</span><b id="stat-final">0</b></div>
            </div>
        </div>

        <div class="action-bar" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <select id="f-subject" onchange="renderTable()" style="width: auto;"><option value="">Semua Subject</option></select>
            <select id="f-editor" onchange="renderTable()" style="width: auto;"><option value="">Semua Editor</option></select>
            <div id="admin-controls" style="margin-left: auto; display: flex; gap: 10px;">
                <button class="btn-main" onclick="openModal('modalNewProject')">+ Project Baru</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Judul Project</th><th>Subject</th><th>Editor</th><th>Deadline</th><th>Status</th>
                        <th>Links</th><th>Note</th><th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="main-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="modalNewProject" class="modal">
        <div class="modal-content">
            <h3>Project Baru</h3>
            <div class="input-group"><label>Judul</label><input type="text" id="n-title"></div>
            <div class="input-group"><label>Subject</label><input type="text" id="n-subject"></div>
            <div class="input-group"><label>Editor</label><input type="text" id="n-editor"></div>
            <div class="input-group"><label>Deadline</label><input type="date" id="n-deadline"></div>
            <div class="input-group"><label>Link Material</label><input type="text" id="n-mat"></div>
            <div class="input-group"><label>Link RAW</label><input type="text" id="n-raw"></div>
            <button class="btn-main" style="width:100%" id="btn-save-new" onclick="saveNewProject()">Simpan ke Spreadsheet</button>
            <button class="btn-main" style="width:100%; background:#888; margin-top:8px" onclick="closeModal('modalNewProject')">Batal</button>
        </div>
    </div>

    <div id="modalAction" class="modal">
        <div class="modal-content">
            <h3 id="a-title-display">Update Status</h3>
            <div class="input-group"><label>Status</label>
                <select id="a-status">
                    <option>To do</option>
                    <option>In Progress</option>
                    <option>Review</option>
                    <option>Revision Needed</option>
                    <option>Retake</option>
                    <option>Finalized</option>
                </select>
            </div>
            <div class="input-group"><label>Link Hasil (Result)</label><input type="text" id="a-result"></div>
            <div class="input-group"><label>Link Revisi</label><input type="text" id="a-revision"></div>
            <div class="input-group"><label>Catatan (Note)</label><textarea id="a-note" rows="3"></textarea></div>
            <button class="btn-main" style="width:100%; margin-top:10px" id="btn-update" onclick="saveAction()">Update Data</button>
            <button class="btn-main" style="width:100%; background:#888; margin-top:10px" onclick="closeModal('modalAction')">Tutup</button>
        </div>
    </div>

    <script>
        // Masukkan URL Deployment Google Apps Script Anda
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzXfz3nntyCZnwo92xuDdU77YZsiUsdbHnSjVBoFbmVSUJizDsQwbNV3F-zWOspSw3l/exec';

        let projects = [];
        let currentUser = null;
        let activeRowIndex = null;
        let myChart = null;

        window.onload = function() {
            const session = localStorage.getItem('podcastSession');
            if (session) {
                currentUser = session;
                showDashboard();
                refreshData();
            }
        };

        function handleLogin() {
            const u = document.getElementById('username').value.trim().toLowerCase();
            if(u === 'admin' || u === 'user') {
                currentUser = u;
                localStorage.setItem('podcastSession', u);
                showDashboard();
                refreshData();
            } else { alert("Login gagal! Gunakan 'admin' atau 'user'"); }
        }

        function handleLogout() { localStorage.removeItem('podcastSession'); location.reload(); }

        function showDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('dashboard-page').style.display = 'block';
            document.getElementById('user-info').innerText = `Logged in as: ${currentUser.toUpperCase()}`;
            if(currentUser === 'user') document.getElementById('admin-controls').classList.add('hidden');
        }

        async function refreshData() {
            toggleLoading(true);
            try {
                const response = await fetch(SCRIPT_URL);
                const data = await response.json();
                
                // Asumsi data[0] adalah header, kita ambil data mulai baris ke-2
                projects = data.slice(1).map((row, index) => ({
                    rowIndex: index + 2, // Baris asli di Excel (Header + 1)
                    title: row[0] || '',
                    subject: row[1] || '',
                    editor: row[2] || '',
                    deadline: row[3] || '',
                    status: row[4] || 'To do',
                    material: row[5] || '',
                    raw: row[6] || '',
                    result: row[7] || '',
                    revision: row[8] || '',
                    note: row[9] || ''
                }));

                updateFilters();
                renderTable();
            } catch (e) {
                alert("Gagal memuat data dari Spreadsheet.");
            }
            toggleLoading(false);
        }

        function renderTable() {
            const fSub = document.getElementById('f-subject').value;
            const fEd = document.getElementById('f-editor').value;
            const tbody = document.getElementById('main-table-body');
            
            const filtered = projects.filter(p => (!fSub || p.subject === fSub) && (!fEd || p.editor === fEd));
            
            tbody.innerHTML = filtered.map(p => {
                let statusColor = getStatusColor(p.status);
                let blinkClass = p.status === 'Revision Needed' ? 'blink-red' : '';
                
                return `<tr>
                    <td><b>${p.title}</b></td>
                    <td>${p.subject}</td>
                    <td>${p.editor}</td>
                    <td>${p.deadline ? new Date(p.deadline).toLocaleDateString('id-ID') : '-'}</td>
                    <td><span class="pill ${blinkClass}" style="background:${statusColor}">${p.status}</span></td>
                    <td>
                        <div style="display:flex; gap:8px;">
                            ${p.material ? `<a href="${p.material}" target="_blank" title="Material"><i class="fa-solid fa-box-open"></i></a>` : ''}
                            ${p.raw ? `<a href="${p.raw}" target="_blank" title="RAW"><i class="fa-solid fa-film"></i></a>` : ''}
                            ${p.result ? `<a href="${p.result}" target="_blank" title="Result" style="color:var(--ios-green)"><i class="fa-solid fa-circle-check"></i></a>` : ''}
                        </div>
                    </td>
                    <td style="max-width:120px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;"><small>${p.note || '-'}</small></td>
                    <td><button onclick="openEdit(${p.rowIndex})"><i class="fa-solid fa-pen-to-square"></i></button></td>
                </tr>`;
            }).join('');
            
            updateStats(filtered);
        }

        async function saveNewProject() {
            const btn = document.getElementById('btn-save-new');
            const payload = {
                action: 'ADD',
                title: document.getElementById('n-title').value,
                subject: document.getElementById('n-subject').value,
                editor: document.getElementById('n-editor').value,
                deadline: document.getElementById('n-deadline').value,
                material: document.getElementById('n-mat').value,
                raw: document.getElementById('n-raw').value
            };

            if(!payload.title) return alert("Judul wajib diisi!");
            
            btn.innerText = "Saving..."; btn.disabled = true;
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            
            closeModal('modalNewProject');
            btn.innerText = "Simpan ke Spreadsheet"; btn.disabled = false;
            setTimeout(refreshData, 1500);
        }

        function openEdit(rowIndex) {
            const p = projects.find(x => x.rowIndex === rowIndex);
            activeRowIndex = rowIndex;
            document.getElementById('a-status').value = p.status;
            document.getElementById('a-result').value = p.result;
            document.getElementById('a-revision').value = p.revision;
            document.getElementById('a-note').value = p.note;
            openModal('modalAction');
        }

        async function saveAction() {
            const btn = document.getElementById('btn-update');
            const payload = {
                action: 'UPDATE',
                rowIndex: activeRowIndex,
                status: document.getElementById('a-status').value,
                result: document.getElementById('a-result').value,
                revision: document.getElementById('a-revision').value,
                note: document.getElementById('a-note').value
            };

            btn.innerText = "Updating..."; btn.disabled = true;
            await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
            
            closeModal('modalAction');
            btn.innerText = "Update Data"; btn.disabled = false;
            setTimeout(refreshData, 1500);
        }

        // Helper UI
        function getStatusColor(s) {
            const colors = { 'Finalized': 'var(--ios-green)', 'In Progress': 'var(--ios-yellow)', 'Review': 'var(--ios-blue)', 'Revision Needed': 'var(--ios-red)', 'Retake': '#5856D6' };
            return colors[s] || '#8e8e93';
        }

        function updateFilters() {
            const subs = [...new Set(projects.map(p => p.subject))].filter(x => x);
            const eds = [...new Set(projects.map(p => p.editor))].filter(x => x);
            document.getElementById('f-subject').innerHTML = '<option value="">Semua Subject</option>' + subs.map(s => `<option value="${s}">${s}</option>`).join('');
            document.getElementById('f-editor').innerHTML = '<option value="">Semua Editor</option>' + eds.map(e => `<option value="${e}">${e}</option>`).join('');
        }

        function updateStats(data) {
            const s = { 
                total: data.length,
                todo: data.filter(x => x.status === 'To do').length,
                progress: data.filter(x => x.status === 'In Progress').length,
                final: data.filter(x => x.status === 'Finalized').length
            };
            document.getElementById('stat-total').innerText = s.total;
            document.getElementById('stat-todo').innerText = s.todo;
            document.getElementById('stat-progress').innerText = s.progress;
            document.getElementById('stat-final').innerText = s.final;

            const ctx = document.getElementById('statusChart').getContext('2d');
            if(myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    datasets: [{
                        data: [s.todo, s.progress, s.final, s.total - (s.todo+s.progress+s.final)],
                        backgroundColor: ['#8e8e93', '#FFCC00', '#34C759', '#007AFF'],
                        borderWidth: 0
                    }]
                },
                options: { cutout: '70%', plugins: { legend: { display: false } } }
            });
        }

        function toggleLoading(show) { document.getElementById('loading-screen').style.display = show ? 'flex' : 'none'; }
        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
