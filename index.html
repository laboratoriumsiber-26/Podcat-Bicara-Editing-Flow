<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Podcast Bicara - Fixed Login</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --ios-blue: #007AFF; --ios-red: #FF3B30; --ios-green: #34C759; --ios-yellow: #FFCC00; --ios-bg: #F2F2F7; }
        body { margin: 0; font-family: -apple-system, sans-serif; background: var(--ios-bg); color: #000; }
        #login-page { height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1590602847861-f357a9332bbc?q=80&w=1920') center/cover; }
        .login-card { background: white; padding: 30px; border-radius: 25px; width: 300px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #dashboard-page { display: none; padding: 20px; max-width: 1550px; margin: auto; }
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .analytics-section { display: flex; gap: 20px; margin-bottom: 20px; }
        .chart-box { background: white; padding: 15px; border-radius: 20px; width: 180px; height: 180px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; flex-grow: 1; }
        .stat-card { background: white; padding: 15px; border-radius: 18px; border-left: 4px solid var(--ios-blue); }
        .stat-card b { font-size: 24px; display: block; }
        .table-container { background: white; border-radius: 20px; overflow-x: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        th { background: #f9f9f9; padding: 15px; text-align: left; font-size: 11px; color: #888; border-bottom: 1px solid #eee; }
        td { padding: 15px; border-bottom: 1px solid #f2f2f7; font-size: 13px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 5vh auto; padding: 25px; width: 90%; max-width: 450px; border-radius: 25px; max-height: 85vh; overflow-y: auto; }
        .input-group { margin-bottom: 12px; }
        label { font-size: 11px; font-weight: bold; color: #888; display: block; margin-bottom: 5px; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .btn-main { background: var(--ios-blue); color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .pill { padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: bold; color: white; }
        .mgmt-list { margin: 10px 0; padding: 0; list-style: none; background: #fff; border-radius: 10px; }
        .mgmt-item { display: flex; justify-content: space-between; padding: 8px 12px; border-bottom: 1px solid #eee; font-size: 12px; align-items: center; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <div id="login-page">
        <div class="login-card">
            <h2 style="margin-top:0">Podcast Bicara</h2>
            <p style="font-size: 12px; color: #666;">Gunakan "admin" atau "user"</p>
            <input type="text" id="username" placeholder="Username">
            <input type="password" id="password" placeholder="Password" style="margin-top:10px">
            <button class="btn-main" style="width:100%; margin-top:20px" onclick="handleLogin()">Sign In</button>
        </div>
    </div>

    <div id="dashboard-page">
        <div class="header-bar">
            <div><h2 style="margin:0">Workflow Editing</h2><small id="user-info" style="color:#666"></small></div>
            <button class="btn-main" style="background:#8e8e93" onclick="handleLogout()">Logout</button>
        </div>

        <div class="analytics-section">
            <div class="chart-box"><canvas id="statusChart"></canvas></div>
            <div class="stats-grid">
                <div class="stat-card"><span>Total Project</span><b id="stat-total">0</b></div>
                <div class="stat-card"><span>To do</span><b id="stat-todo">0</b></div>
                <div class="stat-card" style="border-left-color: var(--ios-yellow);"><span>In Progress</span><b id="stat-progress">0</b></div>
                <div class="stat-card" style="border-left-color: var(--ios-green);"><span>Finalized</span><b id="stat-final">0</b></div>
            </div>
        </div>

        <div class="action-bar" style="margin-bottom: 20px; display: flex; gap: 10px;">
            <select id="f-subject" onchange="renderTable()" style="width:auto;"></select>
            <select id="f-editor" onchange="renderTable()" style="width:auto;"></select>
            <div id="admin-controls" style="margin-left: auto; display: flex; gap: 10px;">
                <button class="btn-main" onclick="openModal('modalNewProject')">New Project</button>
                <button class="btn-main" style="background:#333" onclick="openManagement()">Management</button>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Title</th><th>Subject</th><th>Editor</th><th>Deadline</th><th>Status</th>
                        <th>Material</th><th>RAW</th><th>Result</th><th>Revision</th><th>Note</th><th>Action</th>
                    </tr>
                </thead>
                <tbody id="main-table-body"></tbody>
            </table>
        </div>
    </div>

    <div id="modalManagement" class="modal">
        <div class="modal-content">
            <h3>Management Settings</h3>
            <label>Daftar Editor:</label>
            <div id="list-editor-del" class="mgmt-list"></div>
            <div class="input-group">
                <input type="text" id="m-name" placeholder="Nama Editor">
                <input type="text" id="m-wa" placeholder="WhatsApp (628...)" style="margin-top:5px">
                <button class="btn-main" style="background:var(--ios-green); width:100%; margin-top:5px" onclick="addEditor()">Tambah Editor</button>
            </div>
            <hr>
            <label>Daftar Subject:</label>
            <div id="list-subject-del" class="mgmt-list"></div>
            <div class="input-group">
                <input type="text" id="m-sub" placeholder="Nama Subject">
                <button class="btn-main" style="background:var(--ios-green); width:100%; margin-top:5px" onclick="addSubject()">Tambah Subject</button>
            </div>
            <button class="btn-main" style="width:100%; margin-top:20px; background:#333" onclick="saveManagement()">Simpan & Sinkron Cloud</button>
            <button class="btn-main" style="width:100%; background:#888; margin-top:8px" onclick="closeModal('modalManagement')">Batal</button>
        </div>
    </div>

    <div id="modalNewProject" class="modal">
        <div class="modal-content">
            <h3>New Project</h3>
            <div class="input-group"><label>Project Title</label><input type="text" id="n-title"></div>
            <div class="input-group"><label>Subject</label><select id="n-subject"></select></div>
            <div class="input-group"><label>Editor PJ</label><select id="n-editor"></select></div>
            <div class="input-group"><label>Deadline</label><input type="date" id="n-deadline"></div>
            <div class="input-group"><label>Material Link</label><input type="text" id="n-mat"></div>
            <div class="input-group"><label>RAW Link</label><input type="text" id="n-raw"></div>
            <button class="btn-main" style="width:100%" onclick="saveNewProject()">Simpan Project</button>
            <button class="btn-main" style="width:100%; background:#888; margin-top:8px" onclick="closeModal('modalNewProject')">Batal</button>
        </div>
    </div>

    <div id="modalAction" class="modal">
        <div class="modal-content">
            <h3 id="a-title-display">Project Detail</h3>
            <div class="input-group"><label>Status</label>
                <select id="a-status">
                    <option value="To do">To do</option>
                    <option value="In Progress">In Progress</option>
                    <option value="Review">Review</option>
                    <option value="Revision Needed">Revision Needed</option>
                    <option value="Retake">Retake</option>
                    <option value="Finalized">Finalized</option>
                </select>
            </div>
            <div class="input-group"><label>Link Result</label><input type="text" id="a-result"></div>
            <div class="input-group"><label>Link Revision</label><input type="text" id="a-revision"></div>
            <div class="input-group"><label>Note</label><textarea id="a-note" style="height:80px"></textarea></div>
            <div id="admin-pj-zone" class="hidden"><label>Ganti Editor</label><select id="a-editor-select"></select></div>
            <button class="btn-main" style="width:100%; margin-top:10px" onclick="saveAction()">Update Project</button>
            <div id="admin-delete-zone" class="hidden"><button class="btn-main" style="background:var(--ios-red); width:100%; margin-top:10px" onclick="deleteProject()">Hapus Project</button></div>
            <button class="btn-main" style="width:100%; background:#888; margin-top:8px" onclick="closeModal('modalAction')">Tutup</button>
        </div>
    </div>

    <script>
        // MASUKKAN URL WEB APP ANDA DI SINI
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbztPNhlV5lAXTqmsWU7HBWWjpKs9tRyFvQis9IRtYrzm8CRz2RQefnwfySHOQ5k9_La/exec';

        let currentUser = null;
        let activeId = null;

        // Load Data
        let subjects = JSON.parse(localStorage.getItem('subjects')) || ["Heru Mudiyanto M,Pd", "Drs. Budi"];
        let editors = JSON.parse(localStorage.getItem('editors')) || [{name: "Mohamad Ardan Fahrobi", wa: "62857"}];
        let projects = JSON.parse(localStorage.getItem('projects')) || [];

        window.onload = () => {
            const sess = localStorage.getItem('podcastSession');
            if(sess) { currentUser = sess; showDashboard(); }
        };

        // FIXED LOGIN FUNCTION
        function handleLogin() {
            const userIn = document.getElementById('username').value.trim().toLowerCase();
            if(userIn === 'admin' || userIn === 'user') {
                currentUser = userIn; 
                localStorage.setItem('podcastSession', userIn); 
                showDashboard();
            } else { 
                alert("Login gagal! Pastikan username adalah 'admin' atau 'user'"); 
            }
        }

        function handleLogout() { localStorage.removeItem('podcastSession'); location.reload(); }

        function showDashboard() {
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('dashboard-page').style.display = 'block';
            document.getElementById('user-info').innerText = `Logged in as: ${currentUser.toUpperCase()}`;
            
            if(currentUser === 'user') {
                document.getElementById('admin-controls').style.display = 'none';
            } else {
                document.getElementById('admin-controls').style.display = 'flex';
            }
            
            syncDropdowns(); renderTable();
        }

        function syncDropdowns() {
            const sOpt = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
            const eOpt = editors.map(e => `<option value="${e.name}">${e.name}</option>`).join('');
            document.getElementById('f-subject').innerHTML = '<option value="">Semua Subject</option>' + sOpt;
            document.getElementById('f-editor').innerHTML = '<option value="">Semua Editor</option>' + eOpt;
            document.getElementById('n-subject').innerHTML = sOpt;
            document.getElementById('n-editor').innerHTML = eOpt;
            document.getElementById('a-editor-select').innerHTML = eOpt;
        }

        async function uploadToCloud() {
            const data = { projects, editors, subjects };
            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            } catch(e) { console.error("Sync Error", e); }
        }

        function renderTable() {
            const fs = document.getElementById('f-subject').value;
            const fe = document.getElementById('f-editor').value;
            const tbody = document.getElementById('main-table-body');
            
            tbody.innerHTML = projects
                .filter(p => (!fs || p.subject === fs) && (!fe || p.editor === fe))
                .map(p => `
                    <tr>
                        <td><b>${p.title}</b></td>
                        <td>${p.subject}</td><td>${p.editor}</td><td>${p.deadline}</td>
                        <td><span class="pill" style="background:${getColor(p.status)}">${p.status}</span></td>
                        <td>${p.material ? `<a href="${p.material}" target="_blank">Folder</a>` : '-'}</td>
                        <td>${p.raw ? `<a href="${p.raw}" target="_blank">Link</a>` : '-'}</td>
                        <td>${p.result ? `<a href="${p.result}" target="_blank">Play</a>` : '-'}</td>
                        <td>${p.revision ? `<a href="${p.revision}" target="_blank">Rev</a>` : '-'}</td>
                        <td><small>${p.note || '-'}</small></td>
                        <td><button onclick="openAction(${p.id})">Edit</button></td>
                    </tr>`).join('');
            
            localStorage.setItem('projects', JSON.stringify(projects));
            updateChart();
        }

        function saveNewProject() {
            const title = document.getElementById('n-title').value;
            if(!title) return alert("Isi judul!");
            projects.push({
                id: Date.now(), title,
                subject: document.getElementById('n-subject').value, 
                editor: document.getElementById('n-editor').value,
                deadline: document.getElementById('n-deadline').value, 
                material: document.getElementById('n-mat').value,
                raw: document.getElementById('n-raw').value, 
                status: 'To do', note: '', result: '', revision: ''
            });
            closeModal('modalNewProject');
            renderTable(); uploadToCloud();
        }

        function openAction(id) {
            activeId = id; const p = projects.find(x => x.id === id);
            document.getElementById('a-status').value = p.status;
            document.getElementById('a-result').value = p.result || '';
            document.getElementById('a-revision').value = p.revision || '';
            document.getElementById('a-note').value = p.note || '';
            
            if(currentUser === 'admin') {
                document.getElementById('admin-pj-zone').classList.remove('hidden');
                document.getElementById('admin-delete-zone').classList.remove('hidden');
                document.getElementById('a-editor-select').value = p.editor;
            } else {
                document.getElementById('admin-pj-zone').classList.add('hidden');
                document.getElementById('admin-delete-zone').classList.add('hidden');
            }
            openModal('modalAction');
        }

        function saveAction() {
            const p = projects.find(x => x.id === activeId);
            p.status = document.getElementById('a-status').value;
            p.result = document.getElementById('a-result').value;
            p.revision = document.getElementById('a-revision').value;
            p.note = document.getElementById('a-note').value;
            if(currentUser === 'admin') p.editor = document.getElementById('a-editor-select').value;
            closeModal('modalAction'); renderTable(); uploadToCloud();
        }

        function deleteProject() {
            if(confirm("Hapus?")) { projects = projects.filter(x => x.id !== activeId); closeModal('modalAction'); renderTable(); uploadToCloud(); }
        }

        function openManagement() { renderMgmt(); openModal('modalManagement'); }
        function renderMgmt() {
            document.getElementById('list-editor-del').innerHTML = editors.map((e,i) => `<div class="mgmt-item">${e.name} <button onclick="delEd(${i})">X</button></div>`).join('');
            document.getElementById('list-subject-del').innerHTML = subjects.map((s,i) => `<div class="mgmt-item">${s} <button onclick="delSub(${i})">X</button></div>`).join('');
        }
        function addEditor() { const n=document.getElementById('m-name').value, w=document.getElementById('m-wa').value; if(n){editors.push({name:n, wa:w}); renderMgmt();} }
        function addSubject() { const s=document.getElementById('m-sub').value; if(s){subjects.push(s); renderMgmt();} }
        function delEd(i) { editors.splice(i,1); renderMgmt(); }
        function delSub(i) { subjects.splice(i,1); renderMgmt(); }

        function saveManagement() {
            localStorage.setItem('editors', JSON.stringify(editors));
            localStorage.setItem('subjects', JSON.stringify(subjects));
            syncDropdowns(); uploadToCloud(); closeModal('modalManagement');
            alert("Updated!");
        }

        function getColor(s) {
            const c = {'To do':'#888','In Progress':'#FFCC00','Finalized':'#34C759','Revision Needed':'#FF3B30','Review':'#007AFF','Retake':'#FF9500'};
            return c[s] || '#000';
        }

        function updateChart() {
            const s = { todo: projects.filter(x=>x.status==='To do').length, progress: projects.filter(x=>x.status==='In Progress').length, final: projects.filter(x=>x.status==='Finalized').length };
            document.getElementById('stat-total').innerText = projects.length;
            document.getElementById('stat-todo').innerText = s.todo;
            document.getElementById('stat-progress').innerText = s.progress;
            document.getElementById('stat-final').innerText = s.final;
            const ctx = document.getElementById('statusChart').getContext('2d');
            if(window.myChart) window.myChart.destroy();
            window.myChart = new Chart(ctx, { type:'doughnut', data:{ datasets:[{data:[s.todo, s.progress, s.final], backgroundColor:['#007AFF','#FFCC00','#34C759']}] }, options:{maintainAspectRatio:false}});
        }

        function openModal(id) { document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
